<script>
  import "../css/options.scss";
  import {
    mdiMicrophone,
    mdiBellRing,
    mdiPencil,
    mdiKeyboard,
    mdiComment
  } from "@mdi/js";
  import Card, { Content } from "@smui/card";
  import Textfield from "@smui/textfield";
  import Tab, { Icon, Label as TabLabel } from "@smui/tab";
  import TabBar from "@smui/tab-bar";
  import Button, { Label } from "@smui/button";
  import { fly } from "svelte/transition";
  import MdiIcon from "./MdiIcon.svelte";
  import OptionCard from "./OptionCard.svelte";
  import OptionPlugin from "./OptionPlugin.svelte";
  import { DEBUG, ICON_COLOR, storage } from "../js/common";
  import { allPlugins } from "../js/plugins";

  let tabs = ["Options", "Supported commands"];
  const tabIndex = new URL(window.location).searchParams.get("tab") || 0;
  let activeTab = tabs[tabIndex];
  let customHotword = "";

  let voiceOption = {
    icon: mdiMicrophone,
    title: "Microphone permission",
    caption: "Allow microphone access to enable voice commands.",
    showScreenshot: true,
    errorCaption:
      "Voice command will not work without microphone access. Please click on the icon " +
      "at the right hand side of the URL bar to grant access.",
    onClick: enabled => {
      location.reload();
    }
  };

  let hotword = {
    icon: mdiMicrophone,
    title: '"Hey buddy" hotword detection',
    caption: 'We will listen to "Hey buddy" hotword command in the background.',
    errorCaption:
      "Hotword detection is not enabled. Click here to trigger by saying the hotword",
    onClick: enabled => {
      storage.set({ hotword: enabled });
    }
  };

  let voiceDictation = {
    icon: mdiPencil,
    title: "Voice input mode",
    caption: "Enable voice input when focused on a textbox.",
    errorCaption:
      "Enable this setting will allow you to use speech to text to compose email, " +
      "fill out form, take notes, etc.",
    onClick: enabled => {
      storage.set({ disableVoiceDictation: !enabled });
    }
  };

  let shortcut = {
    icon: mdiKeyboard,
    title: "Keyboard shortcut",
    caption: "",
    errorCaption:
      "Go to chrome://extensions/shortcuts to set the keyboard shortcut.",
    enabled: false,
    onClick: enabled => {
      chrome.tabs.query(
        {
          active: true
        },
        tabs => {
          if (tabs.length > 0) {
            const activeTab = tabs[0];
            chrome.tabs.update(activeTab.id, {
              url: "chrome://extensions/shortcuts"
            });
          }
        }
      );
    }
  };

  chrome.commands.getAll(commands => {
    shortcut.caption = commands[0].shortcut || "";
    shortcut.enabled = !!shortcut.caption;
  });

  storage.get(
    ["customHotword", "hotword", "disableInfoPrompt", "disableVoiceDictation"],
    result => {
      customHotword = result.customHotword || "";
      hotword.enabled = result.hotword;
      voiceDictation.enabled = !result.disableVoiceDictation;
    }
  );

  navigator.mediaDevices
    .getUserMedia({ audio: true })
    .then(stream => {
      voiceOption.enabled = true;
    })
    .catch(error => {
      voiceOption.enabled = false;
    });

  $: storage.set({ customHotword });
</script>

<style>
  :global(.main-content) {
    margin: auto;
    padding: 5px;
    width: 600px;
  }

  :global(.hotword-input) {
    width: 400px;
  }

  :global(.reviews-button) {
    position: absolute;
    right: 5px;
    top: 5px;
  }

  :global(.logo-text) {
    font-size: 1.5em;
  }

  .logo {
    vertical-align: middle;
  }

  .flex-container {
    display: flex;
    flex-wrap: wrap;
  }

  .transition-container {
    position: absolute;
    width: 600px;
  }
</style>

<div class="main-content">
  <h1 class="mdc-typography--headline6">
    <Button href="https://bewisse.com/heybuddy/">
      <img class="logo" src="img/icon_128.png" height="32" alt="Logo" />
      &nbsp;
      <Label class="logo-text">Hey Buddy - Chrome Voice Assistant</Label>
    </Button>
    <Button
      class="reviews-button"
      href="https://chrome.google.com/webstore/detail/chrome-voice-assistant/aollofiafbblhopkofbfmlmbhbdcblem"
      target="_blank">
      <MdiIcon size="24" icon={mdiComment} color={ICON_COLOR} />
      &nbsp;
      <Label color={ICON_COLOR}>Review & Feedbacks</Label>
    </Button>
  </h1>

  <TabBar {tabs} let:tab bind:active={activeTab}>
    <Tab {tab}>
      <Label>{tab}</Label>
    </Tab>
  </TabBar>
  {#if activeTab === tabs[0]}
    <div class="transition-container" transition:fly={{ x: -200 }}>
      {#if !voiceOption.enabled}
        <OptionCard option={voiceOption} />
      {:else}
        <OptionCard option={hotword} />
      {/if}
      <OptionCard option={voiceDictation} />
      <OptionCard option={shortcut} />
      <Card class="card">
        <Content>
          <div class="mdc-typography--subtitle1">Hotwords</div>
          <div class="mdc-typography--caption">
            Say one of these hotwords to trigger Hey Buddy by voice.
          </div>
          <Textfield
            variant="filled"
            disabled
            class="hotword-input"
            value="Hey Buddy (default and cannot be changed)"
            input$readonly
            input$aria-readonly />
          <Textfield
            variant="outlined"
            class="hotword-input"
            input$placeholder="Set custom hotword"
            bind:value={customHotword}
            input$minlength="5" />
        </Content>
      </Card>
    </div>
  {/if}
  {#if activeTab === tabs[1]}
    <div
      class="flex-container transition-container"
      transition:fly={{ x: 200 }}>
      {#each allPlugins as plugin}
        <OptionPlugin {plugin} />
      {/each}
    </div>
  {/if}
</div>
